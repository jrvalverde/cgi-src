<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>WebGRAMM: processor.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>processor.php</h1><a href="processor_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 &lt;?
00002 <span class="comment">//</span>
00003 <span class="comment">// Customization section:</span>
00004 <span class="comment">//</span>
00005 <span class="comment">//      Set these values appropriately for your environment</span>
00006 <span class="comment">//</span>
00007 <span class="comment"></span>
00008 <span class="comment">/**</span>
00009 <span class="comment"> * Base system location of the user data and result files</span>
00010 <span class="comment"> *</span>
00011 <span class="comment"> *      they should be WWW accessible, but we need</span>
00012 <span class="comment"> *      to specify their location relative to the system /</span>
00013 <span class="comment"> *      while doing internal processing.</span>
00014 <span class="comment"> */</span>
<a name="l00015"></a><a class="code" href="processor_8php.html#a0">00015</a> <a class="code" href="processor_8php.html#a0">$system_tmproot</a>=<span class="stringliteral">"/data/www/EMBnet/tmp"</span>;
00016 <span class="comment"></span>
00017 <span class="comment">/**</span>
00018 <span class="comment"> * Base WWW location of user data and result files:</span>
00019 <span class="comment"> *</span>
00020 <span class="comment"> *      This is the root used to generate the URLs that the</span>
00021 <span class="comment"> *      user will access to see his results.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * @global string http_tmproot</span>
00024 <span class="comment"> */</span>
<a name="l00025"></a><a class="code" href="processor_8php.html#a1">00025</a> <a class="code" href="processor_8php.html#a1">$http_tmproot</a>=<span class="stringliteral">"/tmp"</span>;
00026 <span class="comment"></span>
00027 <span class="comment">/// set to 0 for no debug output, or select a debug level</span>
<a name="l00028"></a><a class="code" href="processor_8php.html#a2">00028</a> <span class="comment"></span><a class="code" href="processor_8php.html#a2">$debug</a>=0;
00029 <span class="comment"></span>
00030 <span class="comment">/**</span>
00031 <span class="comment"> * Location of PDB to VRML converter</span>
00032 <span class="comment"> * </span>
00033 <span class="comment"> * leave empty if you don't have the corresponding program</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> * \todo check if this is used at all on this file or needed here.</span>
00036 <span class="comment"> *</span>
00037 <span class="comment"> * @global string pdb2vrml</span>
00038 <span class="comment"> */</span>
<a name="l00039"></a><a class="code" href="processor_8php.html#a3">00039</a> <a class="code" href="processor_8php.html#a3">$pdb2vrml</a>=<span class="stringliteral">"/opt/structure/bin/pdb2vrml"</span>;
00040 
00041 <span class="comment">//</span>
00042 <span class="comment">// End of configuration section</span>
00043 <span class="comment">//</span>
00044 
00045 <span class="comment">//</span>
00046 <span class="comment">// Start processing</span>
00047 <span class="comment">//</span>
00048 
<a name="l00049"></a><a class="code" href="processor_8php.html#a4">00049</a> <a class="code" href="processor_8php.html#a4">$matching</a>=$_POST[<span class="stringliteral">"matching"</span>];
<a name="l00050"></a><a class="code" href="processor_8php.html#a5">00050</a> <a class="code" href="processor_8php.html#a5">$representation</a>=$_POST[<span class="stringliteral">"representation"</span>];
<a name="l00051"></a><a class="code" href="processor_8php.html#a6">00051</a> <a class="code" href="processor_8php.html#a6">$resolution</a>=$_POST[<span class="stringliteral">"resolution"</span>];
00052 
<a name="l00053"></a><a class="code" href="processor_8php.html#a7">00053</a> <a class="code" href="processor_8php.html#a7">$receptor_name</a> = <span class="stringliteral">"receptor"</span>;
<a name="l00054"></a><a class="code" href="processor_8php.html#a8">00054</a> <a class="code" href="processor_8php.html#a8">$ligand_name</a> = <span class="stringliteral">"ligand"</span>;
00055 
00056 
00057 <span class="comment">//</span>
00058 <span class="comment">// OpenHTML tags</span>
00059 <span class="comment">//</span>
00060 echo <span class="stringliteral">"&lt;HTML&gt;&lt;HEAD&gt;"</span>;
00061 echo <span class="stringliteral">"&lt;title&gt;WebGramm&lt;/title&gt;"</span>;
00062 echo <span class="stringliteral">"&lt;/HEAD&gt;&lt;BODY BGCOLOR=\"LightGrey\"&gt;"</span>;
00063 
00064 <span class="comment">// create the working directory and make it the default directory</span>
<a name="l00065"></a><a class="code" href="processor_8php.html#a9">00065</a> <a class="code" href="processor_8php.html#a9">$work_dir</a> = go_to_work($system_tmproot, $http_tmproot );
00066 
00067 <span class="comment">// upload receptor and ligand coordinates</span>
00068 <a class="code" href="processor_8php.html#a15">upload_data</a>();
00069 
00070 <a class="code" href="processor_8php.html#a11">write_rmol_gr</a>($receptor_name, $ligand_name);
00071 
00072 <a class="code" href="processor_8php.html#a12">write_rpar_gr</a>($matching, $representation, $resolution);
00073 
00074 <a class="code" href="processor_8php.html#a13">write_wlist_gr</a>($receptor_name, $ligand_name);
00075 
00076 <a class="code" href="processor_8php.html#a16">run_gramm</a>($debug);
00077 
00078 <span class="comment">// Make the user browser go to the working directory as well</span>
00079 echo <span class="stringliteral">"&lt;META HTTP-EQUIV=\"Refresh\" CONTENT=\"5; URL=$http_tmproot/$work_dir\"&gt;"</span>;
00080 
00081 <span class="comment">// display background running notice with a pointer to the</span>
00082 <span class="comment">// working dir so the user knows and just in case the automatic</span>
00083 <span class="comment">// redirection fails (so s/he can jump manually).</span>
00084 echo <span class="stringliteral">"&lt;CENTER&gt;&lt;H1&gt;Your GRAMM job has been started&lt;/H1&gt;&lt;BR&gt;&lt;BR&gt;"</span>;
00085 echo <span class="stringliteral">"&lt;H2&gt;When the results are ready they will be available in the "</span>;
00086 echo <span class="stringliteral">"following link: &lt;br&gt;&lt;br&gt;&lt;A HREF=\"$http_tmproot/$work_dir/\"&gt;$random_str&lt;/A&gt;&lt;/CENTER&gt;&lt;/H2&gt;"</span>;
00087 
00088 <span class="comment">//</span>
00089 <span class="comment">// close HTML tags</span>
00090 <span class="comment">//</span>
00091 echo <span class="stringliteral">"&lt;/BODY&gt;&lt;/HTML&gt;"</span>;
00092 
00093 <span class="comment">// and we are done.</span>
<a name="l00094"></a><a class="code" href="processor_8php.html#a10">00094</a> <a class="code" href="processor_8php.html#a10">exit</a>;
00095 <span class="comment"></span>
00096 <span class="comment">/////////////////////////////// SUBROUTINES ////////////////////////////////</span>
00097 <span class="comment"></span><span class="comment"></span>
00098 <span class="comment">/**</span>
00099 <span class="comment"> * Write rmol.gr configuration file</span>
00100 <span class="comment"> *</span>
00101 <span class="comment"> * The file rmol.gr is needed by GRAMM to specify the molecules to be</span>
00102 <span class="comment"> * used for docking.</span>
00103 <span class="comment"> *</span>
00104 <span class="comment"> * @param receptor the file containing the molecule to maintain fixed</span>
00105 <span class="comment"> * @param ligand the file containing the molecule to move around (should</span>
00106 <span class="comment"> *      hence be the smaller one).</span>
00107 <span class="comment"> */</span>
<a name="l00108"></a><a class="code" href="processor_8php.html#a11">00108</a> function <a class="code" href="processor_8php.html#a11">write_rmol_gr</a>($receptor, $ligand)
00109 {
00110     $rmol=<span class="stringliteral">"./rmol.gr"</span>;
00111 
00112     $fp = fopen( <span class="stringliteral">"$rmol"</span>, <span class="stringliteral">"w"</span> );
00113 
00114     fwrite( $fp, <span class="stringliteral">"# Filename  Fragment  ID      Filename  Fragment  ID     [paral/anti  max.ang]\n"</span>);
00115     fwrite( $fp, <span class="stringliteral">"# ----------------------------------------------------------------------------\n"</span>);
00116     fwrite( $fp, <span class="stringliteral">"\n"</span>);
00117     fwrite( $fp, <span class="stringliteral">"$receptor.pdb\t*\treceptor\t$ligand.pdb\t*\tligand\n"</span>);
00118 
00119     fclose( $fp );
00120 
00121 }
00122 <span class="comment"></span>
00123 <span class="comment">/**</span>
00124 <span class="comment"> * Write the configuration file rpar.gr</span>
00125 <span class="comment"> *</span>
00126 <span class="comment"> * The file rpar.gr contains all the parameters that Gramm should use</span>
00127 <span class="comment"> * to perform the docking work.</span>
00128 <span class="comment"> *</span>
00129 <span class="comment"> * We allow users to modify a small amount of these parameters in</span>
00130 <span class="comment"> * order to guarantee some sensible default values in the face of</span>
00131 <span class="comment"> * lay users (the average expected user). More advanced users might</span>
00132 <span class="comment"> * want a fine grained control, but then these may as well run it</span>
00133 <span class="comment"> * on the command line.</span>
00134 <span class="comment"> *</span>
00135 <span class="comment"> * @param matching generic or helix</span>
00136 <span class="comment"> * @param representation whether we use hydrophobic or normal docking</span>
00137 <span class="comment"> * @param resolution    high or low resolution docking</span>
00138 <span class="comment"> *</span>
00139 <span class="comment"> * @note see Gramm documentation for details.</span>
00140 <span class="comment"> */</span>
<a name="l00141"></a><a class="code" href="processor_8php.html#a12">00141</a> function <a class="code" href="processor_8php.html#a12">write_rpar_gr</a>($matching, $representation, $resolution)
00142 {
00143     <span class="comment">//Writing rpar.gr</span>
00144     $rpar=<span class="stringliteral">"./rpar.gr"</span>;
00145 
00146     <span class="keywordflow">if</span> (<a class="code" href="processor_8php.html#a5">$representation</a>==<span class="stringliteral">"hydrophobic"</span>)
00147     {
00148         $projection=<span class="stringliteral">"blackwhite"</span>;
00149     }<span class="keywordflow">else</span>
00150     {
00151         $projection=<span class="stringliteral">"gray"</span>;
00152     }
00153 
00154     $fp1 = fopen( <span class="stringliteral">"$rpar"</span>, <span class="stringliteral">"w"</span> );
00155 
00156         <span class="keywordflow">if</span> ( <a class="code" href="processor_8php.html#a6">$resolution</a>==<span class="stringliteral">"low"</span>)
00157         {
00158             fwrite( $fp1, <span class="stringliteral">"Matching mode (generic/helix) ....................... mmode= $matching\n"</span> );
00159             fwrite( $fp1, <span class="stringliteral">"Grid step ............................................. eta= 6.8\n"</span> );
00160             fwrite( $fp1, <span class="stringliteral">"Repulsion (attraction is always -1) .................... ro= 6.5.\n"</span> );
00161             fwrite( $fp1, <span class="stringliteral">"Attraction double range (fraction of single range) ..... fr= 0.\n"</span> );
00162             fwrite( $fp1, <span class="stringliteral">"Potential range type (atom_radius, grid_step) ....... crang= grid_step\n"</span> );
00163             fwrite( $fp1, <span class="stringliteral">"Projection (blackwhite, gray) ................ ....... ccti= $projection\n"</span> );
00164             fwrite( $fp1, <span class="stringliteral">"Representation (all, hydrophobic) .................... crep= $representation\n"</span> );
00165             fwrite( $fp1, <span class="stringliteral">"Number of matches to output .......................... maxm= 1000\n"</span> );
00166             fwrite( $fp1, <span class="stringliteral">"Angle for rotations, deg (10,12,15,18,20,30, 0-no rot.)  ai= 20\n"</span> );
00167         }<span class="keywordflow">else</span>
00168         {
00169             fwrite( $fp1, <span class="stringliteral">"Matching mode (generic/helix) ....................... mmode= $matching\n"</span> );
00170             fwrite( $fp1, <span class="stringliteral">"Grid step ............................................. eta= 1.7\n"</span> );
00171             fwrite( $fp1, <span class="stringliteral">"Repulsion (attraction is always -1) .................... ro= 30.\n"</span> );
00172             fwrite( $fp1, <span class="stringliteral">"Attraction double range (fraction of single range) ..... fr= 0.\n"</span> );
00173             fwrite( $fp1, <span class="stringliteral">"Potential range type (atom_radius, grid_step) ....... crang= atom_radius\n"</span> );
00174             fwrite( $fp1, <span class="stringliteral">"Projection (blackwhite, gray) ................ ....... ccti= $projection\n"</span> );
00175             fwrite( $fp1, <span class="stringliteral">"Representation (all, hydrophobic) .................... crep= $representation\n"</span> );
00176             fwrite( $fp1, <span class="stringliteral">"Number of matches to output .......................... maxm= 1000\n"</span> );
00177             fwrite( $fp1, <span class="stringliteral">"Angle for rotations, deg (10,12,15,18,20,30, 0-no rot.)  ai= 10\n"</span> );
00178         }
00179 
00180     fclose( $fp1 );
00181 }
00182 <span class="comment"></span>
00183 <span class="comment">/**</span>
00184 <span class="comment"> *      Write configuration file wlist.gr</span>
00185 <span class="comment"> *</span>
00186 <span class="comment"> *      The file wlist.gr is used by GRAMM in the coordinate building</span>
00187 <span class="comment"> * step as a guide to know how many coordinate sets for the docked</span>
00188 <span class="comment"> * ligand and receptor molecules to generate. It tells as well whether</span>
00189 <span class="comment"> * these sets should be saved in a single file or a separate coordinate</span>
00190 <span class="comment"> * files.</span>
00191 <span class="comment"> *</span>
00192 <span class="comment"> *      We use a single file to provide the user with simpler browsing</span>
00193 <span class="comment"> * capabilities. Hence we need minimal information.</span>
00194 <span class="comment"> *</span>
00195 <span class="comment"> * @param receptor the file containing the receptor (fixed) molecule</span>
00196 <span class="comment"> * @param ligand the file containing the ligand (mobile) molecule</span>
00197 <span class="comment"> */</span>
<a name="l00198"></a><a class="code" href="processor_8php.html#a13">00198</a> function <a class="code" href="processor_8php.html#a13">write_wlist_gr</a>($receptor, $ligand)
00199 {
00200     <span class="comment">//Writing wlist.gr</span>
00201     $wlist=<span class="stringliteral">"./wlist.gr"</span>;
00202 
00203     $fp2 = fopen( <span class="stringliteral">"$wlist"</span>, <span class="stringliteral">"w"</span> );
00204 
00205     fwrite( $fp2, <span class="stringliteral">"# File_of_predictions   First_match   Last_match   separate/joint  +init_lig\n"</span> );
00206     fwrite( $fp2, <span class="stringliteral">"# ----------------------------------------------------------------------------\n"</span> );
00207     fwrite( $fp2, <span class="stringliteral">"$receptor-$ligand.res\t1\t10\tsepar\tno\n"</span> );        
00208 
00209     fclose( $fp2 );
00210 
00211 }
00212 <span class="comment"></span>
00213 <span class="comment">/**</span>
00214 <span class="comment"> * Create a temporary work directory and cd to it.</span>
00215 <span class="comment"> *</span>
00216 <span class="comment"> * In order to run the job we need a temporary directory to store the</span>
00217 <span class="comment"> * results. This can not have a static name since then concurrent runs</span>
00218 <span class="comment"> * would overwrite each other's data.</span>
00219 <span class="comment"> * The solution is trivial: we require a seed string to generate the</span>
00220 <span class="comment"> * directory. This string should be unique.</span>
00221 <span class="comment"> */</span>
<a name="l00222"></a><a class="code" href="processor_8php.html#a14">00222</a> function <a class="code" href="processor_8php.html#a14">setup_gramm_tmp_dir</a>( $system_tmproot, $http_tmproot )
00223 {       
00224     $random_str = rand(1000000, 9999999);
00225     <a class="code" href="processor_8php.html#a9">$work_dir</a> = <span class="stringliteral">"webgramm$random_str"</span>;
00226 
00227     mkdir (<span class="stringliteral">"$system_tmproot/$work_dir"</span>, 0755);
00228     copy(<span class="stringliteral">"./gramm.sh"</span>, <span class="stringliteral">"$system_tmproot/$work_dir/gramm.sh"</span>);
00229     copy(<span class="stringliteral">"./Rodin_Penseur.jpg"</span>, <span class="stringliteral">"$system_tmproot/$work_dir/Rodin_Penseur.jpg"</span>);
00230     copy(<span class="stringliteral">"./6h2o-w-small.gif"</span>, <span class="stringliteral">"$system_tmproot/$work_dir/6h2o-w-small.gif"</span>);
00231     copy(<span class="stringliteral">"./left.gif"</span>, <span class="stringliteral">"$system_tmproot/$work_dir/left.gif"</span>);
00232     copy(<span class="stringliteral">"./right.gif"</span>, <span class="stringliteral">"$system_tmproot/$work_dir/right.gif"</span>);
00233     copy(<span class="stringliteral">"./show_results.php"</span>, <span class="stringliteral">"$system_tmproot/$work_dir/index.php"</span>);
00234     chdir( <span class="stringliteral">"$system_tmproot/$work_dir"</span> ); 
00235     chmod (<span class="stringliteral">"./gramm.sh"</span>, 0755);
00236 
00237     <span class="keywordflow">return</span> <a class="code" href="processor_8php.html#a9">$work_dir</a>;
00238 }
00239 <span class="comment"></span>
00240 <span class="comment">/**</span>
00241 <span class="comment"> * Manage uploads</span>
00242 <span class="comment"> *</span>
00243 <span class="comment"> * This function will manage the upload of the files needed to run the</span>
00244 <span class="comment"> * program. We'll retrieve two files which will be saved as receptor.pdb</span>
00245 <span class="comment"> * and ligand.pdb</span>
00246 <span class="comment"> */</span>
00247 
<a name="l00248"></a><a class="code" href="processor_8php.html#a15">00248</a> function <a class="code" href="processor_8php.html#a15">upload_data</a>()
00249 {
00250     <span class="comment">// Two files to upload: Receptor file and Ligand file</span>
00251     <span class="comment">// NB JR: there is a far better way to do this. David did it</span>
00252     <span class="comment">//  this way since he was looking for a generic solution to</span>
00253     <span class="comment">//  upload N files and later adapted it to this problem...</span>
00254 
00255     <span class="keywordflow">for</span> ($i=0; $i&lt;2; $i++) 
00256     {
00257 
00258         <span class="keywordflow">if</span>($i==0)
00259         {
00260             $file_str=<span class="stringliteral">"Receptor"</span>; 
00261             $upfile=<span class="stringliteral">"receptor.pdb"</span>;
00262         }
00263         <span class="keywordflow">else</span>
00264         {
00265             $file_str=<span class="stringliteral">"Ligand"</span>;
00266             $upfile=<span class="stringliteral">"ligand.pdb"</span>;
00267         }
00268 
00269 
00270         $userfile = $_FILES['upload']['tmp_name'][$i];
00271         $userfile_name = $_FILES['upload']['name'][$i];
00272         $userfile_size = $_FILES['upload']['size'][$i];
00273 
00274 
00275         <span class="keywordflow">if</span> ($_FILES['upload']['tmp_name'][$i]==<span class="stringliteral">"none"</span> || $_FILES['upload']['tmp_name'][$i]==<span class="stringliteral">""</span>)
00276         {
00277             echo <span class="stringliteral">"&lt;h1&gt;Problem: no $file_str file uploaded&lt;/h1&gt;"</span>;
00278             <a class="code" href="processor_8php.html#a10">exit</a>;
00279         }
00280 
00281         <span class="keywordflow">if</span> ($_FILES['upload']['size'][$i]==0)
00282         {
00283             echo <span class="stringliteral">"&lt;h1&gt;Problem: uploaded $file_str file is zero length&lt;/h1&gt;"</span>;
00284             <a class="code" href="processor_8php.html#a10">exit</a>;
00285         }
00286 
00287 <span class="comment">//      $upfile = "./$userfile_name";</span>
00288         <span class="keywordflow">if</span> ( !move_uploaded_file($userfile, $upfile)) 
00289         {
00290             echo <span class="stringliteral">"&lt;h1&gt;$userfile -&amp;gt; $upfile Problem: Could not move file into directory&lt;/h1&gt;"</span>; 
00291             <a class="code" href="processor_8php.html#a10">exit</a>;
00292         }
00293 
00294 
00295     }
00296 
00297 }
00298 <span class="comment"></span>
00299 <span class="comment">/**</span>
00300 <span class="comment"> * Run Gramm</span>
00301 <span class="comment"> *</span>
00302 <span class="comment"> * We now have everything ready to start running GRAMM. Launch it.</span>
00303 <span class="comment"> */</span>
<a name="l00304"></a><a class="code" href="processor_8php.html#a16">00304</a> function <a class="code" href="processor_8php.html#a16">run_gramm</a>($debug)
00305 {       
00306         <span class="comment">// Create a Gramm run script (or copy it from our install dir)</span>
00307         <span class="comment">// run the driver script in the background</span>
00308         <span class="comment">//     The driver script:</span>
00309         <span class="comment">//              Runs Gramm directly with args</span>
00310         <span class="comment">//              touches "done"</span>
00311 
00312         $gramm = <span class="stringliteral">"./gramm.sh scan coord &gt;&gt; /dev/null 2&gt;&amp;1"</span>;
00313         <span class="comment">// Note:  If you start a program using this function ( exec ) and want to leave it</span>
00314         <span class="comment">// running in the background, you have to make sure that the output of </span>
00315         <span class="comment">// that program is redirected to a file or some other output stream or </span>
00316         <span class="comment">// else PHP will hang until the execution of the program ends.</span>
00317         <span class="comment">// Gramm creates his own .log file, so we redirect the output to a file</span>
00318         <span class="comment">// called "gramm.log" and after the program execution the modeller.sh</span>
00319         <span class="comment">// script delete this file.</span>
00320 
00321         $started = fopen(<span class="stringliteral">"./started"</span>, <span class="stringliteral">"w"</span>);
00322         fclose($started);       
00323 
00324         exec(<span class="stringliteral">"$gramm"</span>);
00325 
00326         <span class="keywordflow">if</span> (<a class="code" href="processor_8php.html#a2">$debug</a> &gt; 0) 
00327         {
00328             echo <span class="stringliteral">"&lt;CENTER&gt;&lt;H1&gt;Done.&lt;/H1&gt;&lt;/CENTER&gt;"</span>;
00329         }
00330 }
00331 
00332 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Mar 28 22:17:13 2005 for WebGRAMM by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
